pipeline {
    agent none
    stages {
        stage('Test Matrix') {
            matrix {
                axes {
                    axis {
                        name: 'SHARD_INDEX'
                        values: '1', '2'
                    }
                    axis {
                        name: 'AGENT_LABEL'
                        values: 'win-vm-1', 'win-vm-2'
                    }
                }
                stages {
                    stage('Checkout') {
                        agent { label "${AGENT_LABEL}" }
                        steps {
                            checkout scm
                        }
                    }
                    stage('Setup Node.js') {
                        steps {
                            // Make sure Node.js is installed on the Windows VM or use nvm/nvs
                            bat 'node -v'
                        }
                    }
                    stage('Install dependencies') {
                        steps {
                            bat 'npm ci'
                        }
                    }
                    stage('Install Playwright Browsers') {
                        steps {
                            bat 'npx playwright install --with-deps'
                        }
                    }
                    stage('Run Playwright tests') {
                        steps {
                            bat "npx playwright test --shard=${SHARD_INDEX}/2 --config=playwright.actions.config.ts"
                        }
                    }
                    stage('Archive blob report') {
                        steps {
                            archiveArtifacts artifacts: 'blob-report/**', allowEmptyArchive: true
                        }
                    }
                }
            }
        }
    }
}